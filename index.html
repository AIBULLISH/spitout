<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>$SPITOUT – Spit It Out</title>

  <!-- Solana -->
  <script src="https://unpkg.com/@solana/web3.js@1.91.4/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@0.3.11/lib/index.iife.min.js"></script>

  <style>
    :root {
      --bg: #000;
      --card: #111;
      --accent1: #ff007f;
      --accent2: #00bfff;
      --text: #fff;
      --muted: #ccc;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      text-align: center;
      padding: 20px;
    }

    img#logo { width: 180px; margin: 40px 0 10px; }

    h1 {
      font-size: 2.5rem;
      margin: 0 0 10px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 900;
      letter-spacing: 1px;
    }

    #status { color: var(--muted); font-size: 0.95rem; margin-bottom: 16px; }
    .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 20px; }
    button {
      padding: 10px 18px; border: none; border-radius: 25px;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: white; font-weight: 700; cursor: pointer; font-size: 0.95rem;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .small { font-size: 0.85rem; color: var(--muted); }

    .card {
      width: 90%; max-width: 500px; background: var(--card);
      border: 1px solid #333; border-radius: 15px; padding: 16px; margin-bottom: 16px;
    }

    #comments {
      max-height: 400px; overflow-y: auto; display: flex; flex-direction: column;
      gap: 12px; padding-right: 8px; font-size: 0.95rem;
    }

    .comment { display: flex; gap: 10px; align-items: flex-start; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
    .bubble {
      background: #222; color: #eee; padding: 11px 15px; border-radius: 14px;
      max-width: 80%; word-wrap: break-word; line-height: 1.4;
    }

    #composer { display: flex; gap: 10px; margin-top: 12px; }
    #commentInput {
      flex: 1; padding: 12px 16px; border-radius: 25px; border: none;
      background: #222; color: #fff; font-size: 1rem; outline: none;
    }
    #sendBtn {
      padding: 12px 22px; border-radius: 25px; border: none;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      color: #fff; font-weight: 700; cursor: pointer;
    }
    #sendBtn:disabled { opacity: 0.5; cursor: not-allowed; }

    .rules { margin-top: 12px; font-size: 0.8rem; color: #ff4d4d; font-weight: bold; }

    .faq {
      width: 90%; max-width: 500px; background: #0a0a0a; border: 1px solid #333;
      border-radius: 12px; padding: 16px; margin-top: 20px; text-align: left;
      font-size: 0.9rem; color: #aaa;
    }
    .faq h3 { color: var(--accent1); margin: 14px 0 8px; font-size: 1rem; }
  </style>
</head>
<body>

  <img id="logo" src="logo.png" alt="$SPITOUT Logo" />
  <h1>$SPITOUT</h1>
  <div id="status">Connect wallet to spit it out.</div>

  <div class="controls">
    <button id="connectBtn">Connect Wallet</button>
    <div class="small" id="balanceInfo">Balance: —</div>
  </div>

  <div class="card">
    <div id="comments"></div>
    <div id="composer">
      <input id="commentInput" placeholder="Spit it out..." disabled />
      <button id="sendBtn" disabled>Send</button>
    </div>
    <div class="rules">1 Post = 1 $SPITOUT | Min. 30 $SPITOUT to post</div>
  </div>

  <div class="faq">
    <h3>FAQ – What is $SPITOUT?</h3>
    <ul>
      <li><strong>$SPITOUT</strong> is the unfiltered truth booth on Solana.</li>
      <li>No rules. No moderation. No logs.</li>
      <li>Post anything: rage, love, secrets, sins, dreams, chaos.</li>
      <li>Client-only — your words vanish when you reload.</li>
    </ul>
  </div>

  <script>
    // === 100 % WIE CODE A – NUR MIT DEINEM DESIGN ===
    const { Connection, PublicKey, Transaction } = solanaWeb3;
    const { getAssociatedTokenAddress, createTransferInstruction } = splToken;

    const TREASURY_WALLET = new PublicKey("7psAd7T6gCyp9rzKS8xMYa6yBQjLNEi5nJB8qPqtXxQb");
    const SPITOUT_MINT = "DEINE_MINT_HIER_REIN"; // ← HIER DEINE MINT
    const MIN_BALANCE = 30;
    const DECIMALS = 9;

    const connection = new Connection("https://api.mainnet-beta.solana.com");

    let provider = null;
    let publicKey = null;  // ← WICHTIG: KEIN new PublicKey() hier!

    const walletButton = document.getElementById("connectBtn");
    const input = document.getElementById("commentInput");
    const sendButton = document.getElementById("sendBtn");
    const messagesDiv = document.getElementById("comments");
    const statusDiv = document.getElementById("status");
    const balanceInfo = document.getElementById("balanceInfo");

    // === VERBINDUNG – EXAKT WIE CODE A ===
    async function connectWallet() {
      if (window.solana && window.solana.isPhantom) {
        provider = window.solana;
        await provider.connect();
        publicKey = provider.publicKey;  // ← KEIN new PublicKey()!
      } else if (window.solflare) {
        provider = window.solflare;
        await provider.connect();
        publicKey = provider.publicKey;
      } else {
        alert("No Solana wallet found! Install Phantom or Solflare.");
        return;
      }

      walletButton.textContent = "Connected: " + publicKey.toBase58().slice(0,4) + "..." + publicKey.toBase58().slice(-4);
      input.disabled = false;
      sendButton.disabled = false;
      statusDiv.textContent = "Connected. Loading balance...";
      updateBalance();
    }

    // === BALANCE ===
    async function updateBalance() {
      if (!publicKey || SPITOUT_MINT === "DEINE_MINT_HIER_REIN") {
        balanceInfo.innerText = "Mint missing";
        return;
      }
      try {
        const mint = new PublicKey(SPITOUT_MINT);
        const ata = await getAssociatedTokenAddress(mint, publicKey);
        const bal = await connection.getTokenAccountBalance(ata);
        const amount = Number(bal.value.amount) / 10**DECIMALS;
        balanceInfo.innerText = `Balance: ${amount.toFixed(2)} $SPITOUT`;
        statusDiv.textContent = amount >= MIN_BALANCE ? "Ready!" : `Need 30 $SPITOUT`;
      } catch (e) {
        balanceInfo.innerText = "Balance: 0";
      }
    }

    // === SENDEN ===
    async function sendMessage() {
      const msg = input.value.trim();
      if (!msg) return;
      input.value = "";
      appendMessage(publicKey.toBase58(), msg);

      try {
        const mint = new PublicKey(SPITOUT_MINT);
        const userATA = await getAssociatedTokenAddress(mint, publicKey);
        const treasuryATA = await getAssociatedTokenAddress(mint, TREASURY_WALLET);
        const tx = new Transaction().add(createTransferInstruction(userATA, treasuryATA, publicKey, 10**DECIMALS));
        tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;
        tx.feePayer = publicKey;
        const signed = await provider.signTransaction(tx);
        await connection.sendRawTransaction(signed.serialize());
        statusDiv.textContent = "Sent 1 $SPITOUT!";
        setTimeout(updateBalance, 2000);
      } catch (e) {
        alert("Transfer failed: " + e.message);
      }
    }

    function appendMessage(wallet, text) {
      const avatar = "https://i.imgur.com/T5g8V6R.png";
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `<img class="avatar" src="${avatar}" /><div class="bubble">${text}</div>`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // === EVENTS ===
    walletButton.addEventListener("click", connectWallet);
    sendButton.addEventListener("click", sendMessage);
    input.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

    // Start
    appendMessage("System", "Welcome to $SPITOUT – truth costs 1 $SPITOUT.");
  </script>
</body>
</html>
