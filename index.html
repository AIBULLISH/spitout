<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>$SPITOUT – Spit It Out</title>
  <script src="https://unpkg.com/@solana/web3.js@1.91.4/lib/index.iife.min.js"></script>
  <script src="https://unpkg.com/@solana/spl-token@0.3.11/lib/index.iife.min.js"></script>
  <style>
    body {
      background: black;
      color: #d3af37;
      font-family: 'Courier New', monospace;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    img#logo {
      width: 180px;
      margin: 40px 0 10px;
    }
    h1 {
      font-size: 2.5rem;
      margin: 0 0 10px;
      color: #d3af37;
    }
    #status {
      color: #888;
      margin-bottom: 16px;
    }
    .controls {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 20px;
      background-color: #d3af37;
      color: black;
      font-weight: bold;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .card {
      background-color: #111;
      border: 1px solid #333;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      margin: 0 auto 20px;
      padding: 16px;
    }
    #comments {
      max-height: 400px;
      overflow-y: auto;
      text-align: left;
    }
    .comment {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
    }
    .bubble {
      background: #222;
      color: #fff;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: 80%;
      word-wrap: break-word;
    }
    #composer {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    #commentInput {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: none;
      background: #222;
      color: #fff;
    }
    #sendBtn {
      background: #d3af37;
      color: black;
      font-weight: bold;
      border-radius: 20px;
      padding: 10px 18px;
      border: none;
      cursor: pointer;
    }
    #sendBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .rules {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #ff4d4d;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <img id="logo" src="logo.png" alt="$SPITOUT Logo" />
  <h1>$SPITOUT</h1>
  <div id="status">Connect wallet to spit it out.</div>
  <div class="controls">
    <button id="connectBtn">Connect Wallet</button>
    <div id="balanceInfo">Balance: —</div>
  </div>

  <div class="card">
    <div id="comments"></div>
    <div id="composer">
      <input id="commentInput" placeholder="Spit it out..." disabled />
      <button id="sendBtn" disabled>Send</button>
    </div>
    <div class="rules">1 Post = 1 $SPITOUT | Min. 30 $SPITOUT to post</div>
  </div>

  <script>
  (async () => {
    const { Connection, PublicKey, Transaction } = solanaWeb3;
    const { getAssociatedTokenAddress, createTransferInstruction } = splToken;
    const connection = new Connection("https://api.mainnet-beta.solana.com");
    const TREASURY_WALLET = new PublicKey("7psAd7T6gCyp9rzKS8xMYa6yBQjLNEi5nJB8qPqtXxQb");
    const SPITOUT_MINT = "REPLACE_WITH_YOUR_MINT_ADDRESS"; // REPLACE WHEN READY
    const DECIMALS = 9;
    const MIN_BALANCE = 30;
    const POST_COST = 1;

    const connectBtn = document.getElementById("connectBtn");
    const statusEl = document.getElementById("status");
    const balanceInfo = document.getElementById("balanceInfo");
    const commentInput = document.getElementById("commentInput");
    const sendBtn = document.getElementById("sendBtn");
    const commentsDiv = document.getElementById("comments");
    let publicKey = null;

    const AVATARS = [
      "https://i.imgur.com/Pepe1.png",
      "https://i.imgur.com/Pepe2.png",
      "https://i.imgur.com/Pepe3.png",
      "https://i.imgur.com/Pepe4.png",
      "https://i.imgur.com/T5g8V6R.png"
    ];

    function addComment(text) {
      const avatar = AVATARS[Math.floor(Math.random() * AVATARS.length)];
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `<img class="avatar" src="${avatar}" alt="">
                       <div class="bubble">${escapeHtml(text)}</div>`;
      commentsDiv.appendChild(div);
      commentsDiv.scrollTop = commentsDiv.scrollHeight;
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    function showStatus(msg) { statusEl.textContent = msg; }

    async function connectWallet() {
      if (!window.solana || !window.solana.isPhantom) {
        alert("Please install Phantom Wallet.");
        return;
      }
      try {
        const resp = await window.solana.connect();
        publicKey = new PublicKey(resp.publicKey.toString());
        connectBtn.textContent = "Connected";
        showStatus("Connected to Phantom");
        await updateBalance();
      } catch (err) {
        showStatus("Connection canceled or failed.");
      }
    }

    async function updateBalance() {
      if (!publicKey) return;
      if (SPITOUT_MINT === "REPLACE_WITH_YOUR_MINT_ADDRESS") {
        showStatus("Token not launched yet.");
        balanceInfo.textContent = "Launch pending...";
        commentInput.disabled = true;
        sendBtn.disabled = true;
        return;
      }
      try {
        const mintPub = new PublicKey(SPITOUT_MINT);
        const ata = await getAssociatedTokenAddress(mintPub, publicKey);
        let balance = 0;
        try {
          const acc = await connection.getTokenAccountBalance(ata);
          balance = Number(acc.value.amount) / (10 ** DECIMALS);
        } catch {
          balance = 0;
        }
        balanceInfo.textContent = `Balance: ${balance.toFixed(2)} $SPITOUT`;
        if (balance >= MIN_BALANCE) {
          commentInput.disabled = false;
          sendBtn.disabled = false;
          showStatus("Ready to spit.");
        } else {
          commentInput.disabled = true;
          sendBtn.disabled = true;
          showStatus(`Need 30 $SPITOUT (You have ${balance.toFixed(2)})`);
        }
      } catch (e) {
        showStatus("Error fetching balance.");
      }
    }

    async function postComment(text) {
      if (!publicKey) return;
      const amount = POST_COST * (10 ** DECIMALS);
      try {
        const mintPub = new PublicKey(SPITOUT_MINT);
        const userATA = await getAssociatedTokenAddress(mintPub, publicKey);
        const treasuryATA = await getAssociatedTokenAddress(mintPub, TREASURY_WALLET);
        const tx = new Transaction().add(
          createTransferInstruction(userATA, treasuryATA, publicKey, amount)
        );
        tx.feePayer = publicKey;
        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;
        const signed = await window.solana.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        await connection.confirmTransaction(sig, "confirmed");
        addComment(text);
        commentInput.value = "";
        await updateBalance();
      } catch (e) {
        alert("Error: " + (e.message || "Transaction failed"));
      }
    }

    connectBtn.onclick = connectWallet;
    sendBtn.onclick = async () => {
      const text = commentInput.value.trim();
      if (!text) return;
      sendBtn.disabled = true;
      commentInput.disabled = true;
      await postComment(text);
      setTimeout(updateBalance, 1000);
    };

    commentInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !sendBtn.disabled) sendBtn.click();
    });

    addComment("Welcome to $SPITOUT – the place where truth costs $1.");
    addComment("No filters. No logs. No mercy.");
  })();
  </script>
</body>
</html>
