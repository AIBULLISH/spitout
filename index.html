<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chat</title>
<style>
    body { background:black; color:white; font-family:Arial; }
    #chatBox { width:100%; height:200px; background:#111; padding:10px; overflow-y:auto; border:1px solid #444; }
    #inputBox { width:100%; padding:10px; margin-top:10px; background:#222; color:white; border:1px solid #555; }
    #postBtn { padding:10px 20px; margin-top:10px; background:#333; color:white; border:none; cursor:pointer; }
    #postBtn:disabled { background:#555; cursor:not-allowed; }
    #walletPopup {
        display:none; position:fixed; top:0; left:0; width:100%; height:100%;
        background:rgba(0,0,0,0.8); justify-content:center; align-items:center;
    }
    .popup-content {
        background:#222; padding:20px; border-radius:10px; width:300px; text-align:center;
    }
    .wallet-btn {
        width:100%; padding:12px; background:#333; border:none; color:white;
        margin:7px 0; cursor:pointer; border-radius:8px;
    }
</style>
</head>
<body>

<button id="connectBtn">Connect Wallet</button>

<div id="walletPopup">
    <div class="popup-content">
        <h3>Select Wallet</h3>
        <button class="wallet-btn" data-wallet="phantom">Phantom</button>
        <button class="wallet-btn" data-wallet="solflare">Solflare</button>
        <button class="wallet-btn" data-wallet="bitget">Bitget</button>
        <button class="wallet-btn" data-wallet="binance">Binance Wallet</button>
        <button class="wallet-btn" onclick="closePopup()">Cancel</button>
    </div>
</div>

<div id="chatBox"></div>
<textarea id="inputBox" placeholder="Write something..." disabled></textarea>
<button id="postBtn" disabled>Post</button>

<script type="module">
import {
    Connection,
    PublicKey,
    Transaction,
    SystemProgram,
    clusterApiUrl
} from "https://esm.sh/@solana/web3.js";

import {
    getAssociatedTokenAddress,
    createTransferInstruction
} from "https://esm.sh/@solana/spl-token";


// -------------------------------------------------------------
// SETTINGS (HIER SP√ÑTER TOKEN MINT EINTRAGEN!!!)
// -------------------------------------------------------------
const TOKEN_MINT = "";  // <<<<<<<<< SP√ÑTER EINTRAGEN
const DECIMALS = 9;      // normal f√ºr SPL Tokens

// Deine Wallet (Treasury)
const TREASURY = new PublicKey("7psAd7T6gCyp9rzKS8xMYa6yBQjLNEi5nJB8qPqtXxQb");

// RPC
const connection = new Connection("https://api.mainnet-beta.solana.com");

let walletProvider = null;
let userPublicKey = null;


// -------------------------------------------------------------
// POPUP
// -------------------------------------------------------------
const popup = document.getElementById("walletPopup");

function openPopup() { popup.style.display = "flex"; }
function closePopup() { popup.style.display = "none"; }

document.getElementById("connectBtn").addEventListener("click", () => {
    openPopup();
});


// -------------------------------------------------------------
// WALLET PROVIDER FINDER (AUTO-SCANNER)
// -------------------------------------------------------------
function getProvider(name) {
    const w = window;

    if (name === "phantom" && w.phantom?.solana?.isPhantom) return w.phantom.solana;
    if (name === "solflare" && w.solflare?.isSolflare) return w.solflare;
    if (name === "bitget" && w.bitkeep?.solana) return w.bitkeep.solana;
    if (name === "binance" && w.binanceChain?.solana) return w.binanceChain.solana;

    return null;
}


// -------------------------------------------------------------
// WALLET AUS POPUP W√ÑHLEN
// -------------------------------------------------------------
document.querySelectorAll(".wallet-btn[data-wallet]").forEach(btn => {
    btn.onclick = async () => {
        const name = btn.dataset.wallet;
        walletProvider = getProvider(name);

        if (!walletProvider) {
            alert(name + " Wallet not detected!");
            return;
        }

        try {
            const resp = await walletProvider.connect();
            userPublicKey = new PublicKey(resp.publicKey.toString());
            document.getElementById("connectBtn").innerText = "Wallet Connected";

            closePopup();
            await checkBalanceToUnlock();

        } catch (e) {
            alert("Wallet connection failed");
        }
    };
});


// -------------------------------------------------------------
// 1Ô∏è‚É£ BALANCE CHECK (‚â•30 USD in SPITOUT)
// -------------------------------------------------------------
async function checkBalanceToUnlock() {

    if (!TOKEN_MINT) {
        console.warn("TOKEN MINT NOT SET ‚Äî CHAT STAYS LOCKED");
        return;
    }

    const mint = new PublicKey(TOKEN_MINT);

    const ata = await getAssociatedTokenAddress(mint, userPublicKey);

    try {
        const balance = await connection.getTokenAccountBalance(ata);
        const amount = balance.value.uiAmount ?? 0;

        if (amount >= 30) {
            document.getElementById("inputBox").disabled = false;
            document.getElementById("postBtn").disabled = false;
        }

    } catch {
        console.warn("User does not hold this token.");
    }
}


// -------------------------------------------------------------
// 2Ô∏è‚É£ PRO POST ‚Üí 1 USD IN SPITOUT AN DEINE WALLET
// -------------------------------------------------------------
document.getElementById("postBtn").addEventListener("click", async () => {

    if (!TOKEN_MINT) {
        alert("Token mint not set yet!");
        return;
    }

    const input = document.getElementById("inputBox");
    const text = input.value.trim();
    if (!text) return;

    try {
        await sendOneDollar();
        addPost(text);
        input.value = "";

    } catch (e) {
        alert("Payment failed: " + e);
    }
});


async function sendOneDollar() {
    const mint = new PublicKey(TOKEN_MINT);

    const fromATA = await getAssociatedTokenAddress(mint, userPublicKey);
    const toATA = await getAssociatedTokenAddress(mint, TREASURY);

    const amount = 1 * (10 ** DECIMALS); // 1 USD in SPITOUT (du setzt Preis sp√§ter fest!)

    const ix = createTransferInstruction(fromATA, toATA, userPublicKey, amount);

    const tx = new Transaction().add(ix);
    tx.feePayer = userPublicKey;

    const block = await connection.getLatestBlockhash();
    tx.recentBlockhash = block.blockhash;

    const signed = await walletProvider.signTransaction(tx);
    const txid = await connection.sendRawTransaction(signed.serialize());
    await connection.confirmTransaction(txid, "confirmed");

    return txid;
}


// -------------------------------------------------------------
// 3Ô∏è‚É£ KOMMENTAR ANZEIGEN (LOCAL ONLY, WIE VORHER!)
// -------------------------------------------------------------
function addPost(msg) {
    const box = document.getElementById("chatBox");

    const avatars = ["üê±","üê∏","üêµ","ü¶ä","üêº","üêß","üê∂"];
    const avatar = avatars[Math.floor(Math.random() * avatars.length)];

    const el = document.createElement("div");
    el.innerText = avatar + "  " + msg;
    box.appendChild(el);
}
</script>

</body>
</html>
