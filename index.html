<script>
  (async () => {
    const TREASURY_WALLET = new solanaWeb3.PublicKey("7psAd7T6gCyp9rzKS8xMYa6yBQjLNEi5nJB8qPqtXxQb");
    const SPITOUT_MINT = "DEINE_ECHTE_MINT_HIER"; // <<<<<<< HIER DEINE MINT REIN!
    const MIN_BALANCE_USD = 30;
    const DECIMALS = 9;

    const { Connection, Transaction, PublicKey } = solanaWeb3;
    const { getAssociatedTokenAddress, createTransferInstruction } = splToken;
    const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");

    const connectBtn = document.getElementById("connectBtn");
    const statusEl = document.getElementById("status");
    const balanceInfo = document.getElementById("balanceInfo");
    const commentInput = document.getElementById("commentInput");
    const sendBtn = document.getElementById("sendBtn");
    const commentsDiv = document.getElementById("comments");

    let wallet = null;
    let provider = null;
    let userPubkey = null;

    const AVATARS = [
      "https://i.imgur.com/Pepe1.png",
      "https://i.imgur.com/Pepe2.png",
      "https://i.imgur.com/Pepe3.png",
      "https://i.imgur.com/Pepe4.png",
      "https://i.imgur.com/T5g8V6R.png"
    ];

    function addComment(text) {
      const avatar = AVATARS[Math.floor(Math.random() * AVATARS.length)];
      const div = document.createElement("div");
      div.className = "comment";
      div.innerHTML = `<img class="avatar" src="${avatar}" alt="" />
                       <div class="bubble">${escapeHtml(text)}</div>`;
      commentsDiv.prepend(div); // neueste oben
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function showStatus(txt) { statusEl.innerText = txt; }

    // NEUER CONNECT CODE (Wallet Standard 2025)
    async function connectWallet() {
      if (wallet) {
        await wallet.disconnect();
        wallet = null; provider = null; userPubkey = null;
        connectBtn.innerText = "Connect Wallet";
        showStatus("Connect wallet to spit it out.");
        balanceInfo.innerText = "Balance: â€”";
        commentInput.disabled = sendBtn.disabled = true;
        return;
      }

      const wallets = window.solana && window.solana.wallets 
        ? window.solana.wallets.filter(w => w.features.has("solana:connect"))
        : [];

      // Fallback: alte Phantom-Erkennung
      if (!wallets.length && window.solana && window.solana.isPhantom) {
        wallets.push(window.solana);
      }
      if (!wallets.length && window.backpack) {
        wallets.push({ ...window.backpack, name: "Backpack" });
      }

      if (!wallets.length) {
        showStatus("Kein Wallet gefunden! Phantom/Backpack/Solflare installieren.");
        alert("Bitte installiere Phantom, Backpack oder Solflare und lade neu.");
        return;
      }

      // Wallet auswÃ¤hlen
      let chosen = wallets[0];
      if (wallets.length > 1) {
        const names = wallets.map(w => w.name).join(", ");
        const choice = prompt(`Wallet wÃ¤hlen:\n${names}\n(Tippfehler-OK)`);
        chosen = wallets.find(w => w.name.toLowerCase().includes(choice?.toLowerCase())) || wallets[0];
      }

      try {
        provider = chosen;
        wallet = await provider.connect();
        userPubkey = new PublicKey(wallet.publicKey.toString());

        connectBtn.innerText = "Disconnect";
        showStatus(`Verbunden mit ${provider.name} âœ…`);
        await updateBalance();
        commentInput.disabled = false;
      } catch (e) {
        console.error(e);
        showStatus("Verbindung fehlgeschlagen.");
      }
    }

    async function updateBalance() {
      if (!userPubkey || SPITOUT_MINT === "DEINE_ECHTE_MINT_HIER") {
        balanceInfo.innerText = "Mint fehlt!";
        return;
      }
      try {
        const mintPub = new PublicKey(SPITOUT_MINT);
        const ata = await getAssociatedTokenAddress(mintPub, userPubkey);
        const acc = await connection.getTokenAccountBalance(ata);
        const balance = Number(acc.value.amount) / (10 ** DECIMALS);

        balanceInfo.innerText = `Balance: ${balance.toFixed(2)} $SPITOUT`;
        if (balance >= MIN_BALANCE_USD) {
          sendBtn.disabled = false;
          showStatus("Bereit zum Spitten! ðŸ”¥");
        } else {
          sendBtn.disabled = true;
          showStatus(`Mind. 30 $SPITOUT nÃ¶tig (${balance.toFixed(2)} vorhanden)`);
        }
      } catch (e) {
        balanceInfo.innerText = "Balance: 0 (ATA fehlt?)";
        sendBtn.disabled = true;
      }
    }

    async function postComment(text) {
      if (!provider || !userPubkey) return;
      sendBtn.disabled = true;

      try {
        const mintPub = new PublicKey(SPITOUT_MINT);
        const userATA = await getAssociatedTokenAddress(mintPub, userPubkey);
        const treasuryATA = await getAssociatedTokenAddress(mintPub, TREASURY_WALLET);

        const tx = new Transaction().add(
          createTransferInstruction(userATA, treasuryATA, userPubkey, 1 * 10**DECIMALS)
        );

        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;
        tx.feePayer = userPubkey;

        const signed = await provider.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        await connection.confirmTransaction(sig, "confirmed");

        addComment(text);
        commentInput.value = "";
        showStatus("Gesendet! ðŸ”¥");
        setTimeout(updateBalance, 2000);
      } catch (e) {
        console.error(e);
        alert("Fehler: " + (e.message || "Transaktion abgebrochen"));
        showStatus("Fehler beim Senden.");
      } finally {
        sendBtn.disabled = false;
      }
    }

    // Events
    connectBtn.onclick = connectWallet;
    sendBtn.onclick = () => {
      const text = commentInput.value.trim();
      if (text && !sendBtn.disabled) postComment(text);
    };
    commentInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !sendBtn.disabled) sendBtn.click();
    });

    // Start
    addComment("Willkommen bei $SPITOUT â€“ Wahrheit kostet 1 $");
    addComment("Kein Filter. Kein Log. Nur Chaos.");

    // Auto-Detect
    setTimeout(() => {
      if ((window.solana?.wallets?.length || 0) > 0 || window.solana?.isPhantom || window.backpack) {
        showStatus("Wallet erkannt â€“ klick zum Verbinden!");
        connectBtn.style.animation = "pulse 2s infinite";
      }
    }, 800);
  })();
</script>

<style>
  @keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(255,0,127,0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255,0,127,0); }
    100% { box-shadow: 0 0 0 0 rgba(255,0,127,0); }
  }
</style>
